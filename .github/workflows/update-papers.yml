name: Update Papers

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        
    - name: éªŒè¯æœç´¢é…ç½®
      run: |
        echo "ğŸ” éªŒè¯æœç´¢é…ç½®æ–‡ä»¶..."
        python3 scripts/validate_search_config.py
        
    - name: éªŒè¯å¿…è¦æ–‡ä»¶
      run: |
        echo "ğŸ“ æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        ls -la data/
        test -f data/keywords.json || { echo "âŒ keywords.json æ–‡ä»¶ä¸å­˜åœ¨"; exit 1; }
        test -f data/search_config.json || test -f data/user_config.json || { echo "âŒ search_config.json å’Œ user_config.json éƒ½ä¸å­˜åœ¨"; exit 1; }
        echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶å­˜åœ¨"
        if [ -f data/user_config.json ]; then
          echo "ğŸ“‹ æ£€æµ‹åˆ° user_config.jsonï¼Œå°†ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰é…ç½®"
        fi
        
    - name: è¿è¡Œçˆ¬è™«
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ•·ï¸ å¼€å§‹è¿è¡Œçˆ¬è™«..."
        python3 main.py search
        echo "âœ… çˆ¬è™«è¿è¡Œå®Œæˆ"
        
    - name: éªŒè¯çˆ¬è™«è¾“å‡º
      run: |
        echo "ğŸ“Š éªŒè¯çˆ¬è™«è¾“å‡º..."
        ls -la data/papers_*.json || { echo "âŒ æ²¡æœ‰ç”Ÿæˆè®ºæ–‡æ•°æ®æ–‡ä»¶"; exit 1; }
        echo "âœ… è®ºæ–‡æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
        
    - name: æ›´æ–°README
      run: |
        echo "ğŸ“ æ›´æ–° README..."
        python3 main.py readme --show-latest --show-abstracts
        echo "âœ… README æ›´æ–°å®Œæˆ"
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ˆ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
        fi
        
    - name: æäº¤æ›´æ”¹
      if: steps.verify-changed-files.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data/ README.md
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d %H:%M UTC')"
        
    - name: æ¨é€æ›´æ”¹
      if: steps.verify-changed-files.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        
    - name: å·¥ä½œæµç¨‹å®Œæˆé€šçŸ¥
      run: |
        if [ "${{ steps.verify-changed-files.outputs.has_changes }}" == "true" ]; then
          echo "ğŸ‰ å·¥ä½œæµç¨‹å®Œæˆï¼å·²æ›´æ–°å¹¶æ¨é€æ›´æ”¹ã€‚"
        else
          echo "âœ… å·¥ä½œæµç¨‹å®Œæˆï¼æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤ã€‚"
        fi

